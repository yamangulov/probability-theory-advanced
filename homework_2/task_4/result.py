import numpy as np
from scipy import stats

# Данные задачи 4
print("Задача 4: Проверка гипотезы о доле (вероятности)")
print("Проверка равенства смертности среди мужчин и женщин")
print()

# Параметры задачи
p0 = 0.52  # Теоретическая доля новорожденных мальчиков
n = 5000   # Размер выборки
x = 2500   # Количество мужчин в выборке
alpha = 0.05  # Уровень значимости

print("Данные:")
print(f"Теоретическая доля новорожденных мальчиков: p₀ = {p0}")
print(f"Размер выборки: n = {n}")
print(f"Количество мужчин в выборке: x = {x}")
print(f"Уровень значимости: α = {alpha}")
print()

# Наблюдаемая доля
p_hat = x / n

print(f"Наблюдаемая доля мужчин в выборке: p̂ = {p_hat}")
print(f"Разность: p̂ - p₀ = {p_hat - p0:.4f}")
print()

# 1. ПРОВЕРКА УСЛОВИЙ ПРИМЕНИМОСТИ Z-ТЕСТА
print("1. ПРОВЕРКА УСЛОВИЙ ПРИМЕНИМОСТИ")
print("-" * 50)

np_condition = n * p0
nq_condition = n * (1 - p0)

print(f"Условие 1: n × p₀ = {np_condition} > 5: {'✓' if np_condition > 5 else '✗'}")
print(f"Условие 2: n × (1-p₀) = {nq_condition} > 5: {'✓' if nq_condition > 5 else '✗'}")

# Для z-теста долей также проверим условия для наблюдаемой доли
np_obs = n * p_hat
nq_obs = n * (1 - p_hat)

print(f"Дополнительные условия для наблюдаемой доли:")
print(f"n × p̂ = {np_obs} {'≥ 5' if np_obs >= 5 else '< 5'}: {'✓' if np_obs >= 5 else '✗'}")
print(f"n × (1-p̂) = {nq_obs} {'≥ 5' if nq_obs >= 5 else '< 5'}: {'✓' if nq_obs >= 5 else '✗'}")

all_conditions = np_condition > 5 and nq_condition > 5 and np_obs >= 5 and nq_obs >= 5

if all_conditions:
    print("✓ Все условия применимости z-теста выполнены")
    test_applicable = True
else:
    print("✗ Некоторые условия применимости z-теста НЕ выполнены")
    print("⚠ z-тест может давать неточные результаты!")
    print("  Рекомендуется использовать точный биномиальный тест")
    test_applicable = False

print()

# 2. ФОРМУЛИРОВКА ГИПОТЕЗ
print("2. ФОРМУЛИРОВКА ГИПОТЕЗ")
print("-" * 50)
print("H₀: p = 0,52 (смертность среди мужчин и женщин одинакова)")
print("H₁: p ≠ 0,52 (смертность среди мужчин и женщин различна)")
print("Критерий: Двусторонний z-тест для долей")
print()

if test_applicable:
    # 3. Z-ТЕСТ ДЛЯ ДОЛЕЙ
    print("3. Z-ТЕСТ ДЛЯ ДОЛЕЙ")
    print("-" * 50)

    # Стандартная ошибка при верности H0
    se = np.sqrt(p0 * (1 - p0) / n)

    # Z-статистика
    z_stat = (p_hat - p0) / se

    print(f"Стандартная ошибка: σ₀ = √(p₀(1-p₀)/n) = {se:.6f}")
    print(f"Z-статистика: zнабл = (p̂ - p₀)/σ₀ = {z_stat:.4f}")
    print()

    # Критические значения
    z_critical_left = stats.norm.ppf(alpha/2)
    z_critical_right = stats.norm.ppf(1 - alpha/2)

    print(f"Критические значения (α = {alpha}):")
    print(f"Левая критическая точка: z_{alpha/2:.3f} = {z_critical_left:.3f}")
    print(f"Правая критическая точка: z_{1-alpha/2:.3f} = {z_critical_right:.3f}")
    print()

    # P-значение
    p_value = 2 * (1 - stats.norm.cdf(abs(z_stat)))
    print(f"P-значение: {p_value:.6f}")
    print()

    # 4. РЕЗУЛЬТАТ ТЕСТА
    print("4. РЕЗУЛЬТАТ ТЕСТА")
    print("-" * 50)

    reject_null = p_value < alpha

    if reject_null:
        print(f"P-значение ({p_value:.6f}) < α ({alpha})")
        print("Отвергаем основную гипотезу H₀")
        print("Принимаем альтернативную гипотезу H₁")
        print("✓ Смертность среди мужчин и женщин статистически РАЗЛИЧНА")
        
        if z_stat < 0:
            print("  Наблюдаемая доля мужчин (50%) меньше теоретической (52%)")
            print("  Это указывает на БОЛЬШУЮ смертность среди мужчин")
        else:
            print("  Наблюдаемая доля мужчин больше теоретической")
            print("  Это указывает на БОЛЬШУЮ смертность среди женщин")
    else:
        print(f"P-значение ({p_value:.6f}) ≥ α ({alpha})")
        print("Нет оснований отвергать основную гипотезу H₀")
        print("✗ Смертность среди мужчин и женщин можно считать одинаковой")

    print()
    print("5. ДОПОЛНИТЕЛЬНАЯ ИНФОРМАЦИЯ")
    print("-" * 50)

    # Сравнение с критическими точками
    if abs(z_stat) > abs(z_critical_right):
        print(f"|zнабл| ({abs(z_stat):.4f}) > |zкр| ({abs(z_critical_right):.4f})")
        print("zнабл попадает в критическую область")
    else:
        print(f"|zнабл| ({abs(z_stat):.4f}) ≤ |zкр| ({abs(z_critical_right):.4f})")
        print("zнабл не попадает в критическую область")

    # Доверительный интервал для истинной доли
    se_ci = np.sqrt(p_hat * (1 - p_hat) / n)
    ci_lower = p_hat - stats.norm.ppf(1 - alpha/2) * se_ci
    ci_upper = p_hat + stats.norm.ppf(1 - alpha/2) * se_ci

    print(f"95% доверительный интервал для истинной доли мужчин: [{ci_lower:.4f}, {ci_upper:.4f}]")
    print(f"Теоретическое значение 0,52 {'попадает' if ci_lower <= 0.52 <= ci_upper else 'НЕ попадает'} в доверительный интервал")

else:
    # Точный биномиальный тест
    print("3. ТОЧНЫЙ БИНОМИАЛЬНЫЙ ТЕСТ")
    print("-" * 50)
    print("Поскольку условия применимости z-теста не выполнены,")
    print("используем точный биномиальный тест")
    print()

    # Биномиальный тест
    p_value = stats.binom_test(x, n, p0, alternative='two-sided')
    
    print(f"Точный биномиальный тест:")
    print(f"P-значение: {p_value:.6f}")
    
    # Критические значения для биномиального теста
    # Найдем границы критической области
    alpha_left = alpha / 2
    
    # Для больших n используем нормальное приближение для поиска границ
    # но это приблизительно
    print()
    print("4. РЕЗУЛЬТАТ БИНОМИАЛЬНОГО ТЕСТА")
    print("-" * 50)
    
    reject_null = p_value < alpha
    
    if reject_null:
        print(f"P-значение ({p_value:.6f}) < α ({alpha})")
        print("Отвергаем основную гипотезу H₀")
        print("Принимаем альтернативную гипотезу H₁")
        print("✓ Смертность среди мужчин и женщин статистически РАЗЛИЧНА")
    else:
        print(f"P-значение ({p_value:.6f}) ≥ α ({alpha})")
        print("Нет оснований отвергать основную гипотезу H₀")
        print("✗ Смертность среди мужчин и женщин можно считать одинаковой")

print()
print("ПРАКТИЧЕСКАЯ ИНТЕРПРЕТАЦИЯ:")
print("-" * 50)
print("Если гипотеза H₀ отвергается, это означает, что смертность среди")
print("мужчин и женщин различна. Доля мужчин в зрелом возрасте (30-60 лет)")
print(f"составляет {p_hat:.1%}, что отличается от доли новорожденных мальчиков ({p0:.1%}).")
print("Это может указывать на различную продолжительность жизни.")

if __name__ == "__main__":
    pass
